<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tase</a> &gt; <a href="index.source.html" class="el_package">com.maya</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">package com.maya;

import java.util.Map;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.io.BufferedReader;
import java.io.DataOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Reader;
import java.net.CookieManager;
import java.net.HttpCookie;
import java.net.HttpURLConnection;
import java.net.URI;
import java.net.URL;
import java.net.URLEncoder;
import java.util.HashMap;
import java.util.Iterator;
import java.util.logging.*;
import java.util.Optional;
import java.time.LocalDate;


import com.google.gson.Gson;
import com.maya.jsondata.SecurityListing;
import com.maya.utils.FullResponseBuilder;
import com.maya.utils.Utils.Language;

import com.maya.utils.ParameterStringBuilder;
import com.google.gson.reflect.TypeToken;

import java.lang.reflect.Type;
import java.time.LocalDate;

public final class App {

    protected HttpURLConnection con;
<span class="nc" id="L39">    protected Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();</span>
<span class="nc" id="L40">    protected Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
    // protected Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();
<span class="nc" id="L42">    Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
    // protected String response;
<span class="nc" id="L44">    int status = 0;</span>
    
<span class="nc" id="L46">    private App() {</span>
<span class="nc" id="L47">    }</span>
    public static void main(String[] args) {

<span class="nc" id="L50">        System.out.println(&quot;Hello, World!&quot;);</span>

        //Testing main = new Testing();
        //String ignore = main.TestRequest();
        // System.out.println(main.TestRequest());

        
<span class="nc" id="L57">        Logger logger = Logger.getLogger(App.class.getName());</span>
<span class="nc" id="L58">        Maya maya = new Maya(logger, 1, false);</span>
        
        List&lt;SecurityListing&gt; allSecurities; 

        try {
            
            /* 
            System.out.println(&quot;Testing::main - before getAllSecurities&quot;);
            allSecurities = maya.getAllSecurities(Language.ENGLISH);
            // System.out.println(allSecurities);

            System.out.println(&quot;Testing::main - after getAllSecurities&quot;);

            
            System.out.println(&quot;Testing:: getNames for Funds&quot;);
            System.out.println(&quot;Testing:: after GetNames - &quot; +maya.getNames(&quot;5113428&quot;));

            System.out.println(&quot;Testing:: getNames for Security&quot;);
            System.out.println(&quot;Testing:: after GetNames - &quot; +maya.getNames(&quot;1135912&quot;));

            System.out.println(&quot;Testing:: getDetails for Security&quot;);
            System.out.println(maya.getSecurityDetails(&quot;1135912&quot;,Language.ENGLISH));
            System.out.println(&quot;Testing:: getDetails for Funds&quot;);
            System.out.println(maya.getFundsDetails(&quot;5113428&quot;, Language.ENGLISH));
            
            */
<span class="nc" id="L84">            System.out.println(&quot;Testing:: getPriceHistory for Funds&quot;);</span>
<span class="nc" id="L85">            System.out.println(maya.getPriceHistoryChunk(&quot;5113428&quot;,LocalDate.of(2024,10,30), LocalDate.of(2024,10,31), 1, Language.ENGLISH ));</span>
            
<span class="nc" id="L87">            System.out.println(&quot;Testing:: getPriceHistory for Security&quot;);</span>
<span class="nc" id="L88">            System.out.println(maya.getPriceHistoryChunk(&quot;1135912&quot;,LocalDate.of(2024,10,30), LocalDate.of(2024,10,31), 1, Language.ENGLISH ));</span>
            
            // historical_prices = maya.getPriceHistory(&quot;1135912&quot;, LocalDate.of(2024, 10, 19), LocalDate.of(2024,10,19), 1, Language.ENGLISH);

            // for (fund_object in historical_prices) {
            //     System.out.println(fund_object);
            // }

            // System.out.println(&quot;Testing:: getPriceHistory for Fund&quot;);
            // historical_prices = maya.get_price_history(security_id=&quot;5118393&quot;, from_data=date(2017, 12, 31));
            // for (fund_object in historical_prices){
            //     System.out.println(fund_object);
            // }

         
<span class="nc" id="L103">        } catch (Exception e) {</span>
<span class="nc" id="L104">            System.out.println(e.getMessage());</span>
<span class="nc" id="L105">            System.out.println(e.getCause());</span>
<span class="nc" id="L106">            System.out.println(e.getClass());</span>
<span class="nc" id="L107">            }</span>
         /* 
         * // response = sendRequest();
         * Map &lt;String, Object&gt; allSecurities = new HashMap&lt;&gt;();
         * try {
         * System.out.println(&quot;before allSecurities mapping&quot;);
         * allSecurities = maya.getAllSecurities(Language.ENGLISH);
         * System.out.println(&quot;after allSecurities mapping&quot;);
         * System.out.println(maya.getNames(&quot;1135912&quot;));
         * System.out.println(maya.getDetails(&quot;1135912&quot;, Language.ENGLISH));
         * 
         * // Map&lt;String, Object&gt; historicalPrices = maya.getPriceHistory(&quot;1135912&quot;,
         * Date(&quot;2024&quot;,&quot;10&quot;,&quot;10&quot;), null, 1, Language.ENGLISH);
         * } catch (Exception e) {
         * System.out.println(&quot;Error&quot;);
         * }
         */
<span class="nc" id="L124">    }</span>

    public void CookieManager() {
<span class="nc" id="L127">        CookieManager cookieManager = new CookieManager();</span>
<span class="nc" id="L128">        String cookiesHeader = con.getHeaderField(&quot;Set-Cookie&quot;);</span>
<span class="nc" id="L129">        Optional&lt;HttpCookie&gt; usernameCookie = null;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (cookiesHeader != null) {</span>
<span class="nc" id="L131">            List&lt;HttpCookie&gt; cookies = HttpCookie.parse(cookiesHeader);</span>
<span class="nc" id="L132">            cookies.forEach(cookie -&gt; cookieManager.getCookieStore()</span>
<span class="nc" id="L133">                    .add(null, cookie));</span>
<span class="nc" id="L134">            usernameCookie = cookies.stream()</span>
<span class="nc" id="L135">                    .findAny()</span>
<span class="nc" id="L136">                    .filter(cookie -&gt; cookie.getName()</span>
<span class="nc" id="L137">                            .equals(&quot;username&quot;));</span>
        }

<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (usernameCookie == null) {</span>
<span class="nc" id="L141">            cookieManager.getCookieStore()</span>
<span class="nc" id="L142">                    .add(null, new HttpCookie(&quot;username&quot;, &quot;john&quot;));</span>
        }

<span class="nc" id="L145">        con.disconnect();</span>
<span class="nc" id="L146">    }</span>

    public String TestRequest() {
        try {
<span class="nc" id="L150">            URL url = new URI(&quot;https://api.tase.co.il/api/content/searchentities?lang=0&quot;).toURL();</span>
<span class="nc" id="L151">            this.con = (HttpURLConnection) url.openConnection();</span>

<span class="nc" id="L153">            this.con.setRequestMethod(&quot;GET&quot;);</span>

            // System.out.println(&quot;Setting params&quot;);
            // params.put(&quot;lang&quot;, &quot;0&quot;);
            // this.con.setDoOutput(true);
            // DataOutputStream out = new DataOutputStream(con.getOutputStream());
            // out.writeBytes(getParamsString(params));
            // out.flush();
            // out.close();

<span class="nc" id="L163">            System.out.println(&quot;Testing::TestRequest - Setting headers&quot;);</span>
<span class="nc" id="L164">            headers.put(&quot;Cache-Control&quot;, &quot;no-cache&quot;);</span>
<span class="nc" id="L165">            headers.put(&quot;referer&quot;, &quot;https://www.tase.co.il/&quot;);</span>
<span class="nc" id="L166">            headers.put(&quot;User-Agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; FSL 7.0.6.01001)&quot;);</span>
<span class="nc" id="L167">            headers.put(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            for (Map.Entry&lt;String, String&gt; entry : headers.entrySet()) {</span>
<span class="nc" id="L169">                con.setRequestProperty(entry.getKey(), entry.getValue());</span>
<span class="nc" id="L170">            }</span>

<span class="nc" id="L172">            this.con.setConnectTimeout(5000);</span>
<span class="nc" id="L173">            this.con.setReadTimeout(5000);</span>

<span class="nc" id="L175">            this.con.setInstanceFollowRedirects(false);</span>

<span class="nc" id="L177">            System.out.println(&quot;Testing::TestRequest - RequestMethod&quot;);</span>
<span class="nc" id="L178">            System.out.println(con.getRequestMethod());</span>

<span class="nc" id="L180">            System.out.println(&quot;Testing::TestRequest - Headers&quot;);</span>
<span class="nc" id="L181">            System.out.println(con.getRequestProperties());</span>
<span class="nc" id="L182">            System.out.println(&quot;Testing::TestRequest - Params&quot;);</span>
<span class="nc" id="L183">            System.out.println(con.getHeaderFields());</span>

<span class="nc" id="L185">            System.out.println(&quot;Testing::TestRequest - Executing Request&quot;);</span>
<span class="nc" id="L186">            status = this.con.getResponseCode();</span>

<span class="nc" id="L188">            System.out.println(&quot;Testing::TestRequest - Status code: &quot; + status);</span>

            // System.out.println(FullResponseBuilder.getFullResponse(con));

<span class="nc" id="L192">            String responseString = getResponse(this.con);</span>

<span class="nc" id="L194">            Gson gson = new Gson();</span>
<span class="nc" id="L195">            Type SecurityListingType = new TypeToken &lt;List&lt;SecurityListing&gt;&gt;() {}.getType();</span>
<span class="nc" id="L196">            List&lt;SecurityListing&gt; list = gson.fromJson(responseString, SecurityListingType);</span>
<span class="nc" id="L197">            Iterator&lt;SecurityListing&gt; securityListingIterator = list.iterator();</span>
            
<span class="nc bnc" id="L199" title="All 2 branches missed.">            while (securityListingIterator.hasNext()) {</span>
<span class="nc" id="L200">                SecurityListing listing = securityListingIterator.next();</span>
<span class="nc" id="L201">                System.out.println(&quot;Testing::TestRequest - &quot; +listing.Name + &quot; &quot;+listing.Type + &quot; (&quot; + listing.SubId + &quot;)&quot;);</span>
<span class="nc" id="L202">            }</span>
            // System.out.println(&quot;Before list&quot;);
            // System.out.println(list);
            // System.out.println(&quot;After list&quot;);

<span class="nc" id="L207">            con.disconnect();</span>
<span class="nc" id="L208">            return FullResponseBuilder.getFullResponse(con);</span>

<span class="nc" id="L210">        } catch (Exception e) {</span>
<span class="nc" id="L211">            System.out.println(e.getMessage());</span>
<span class="nc" id="L212">            System.out.println(e.getStackTrace());</span>
        }

<span class="nc" id="L215">        return &quot;&quot;;</span>

        // return response;
    }

    // private Map&lt;String, Object&gt; getResponseDetails(HttpURLConnection con) {
    private StringBuffer getResponseDetails(HttpURLConnection con) {
        String inputLine;
<span class="nc" id="L223">        StringBuffer content = new StringBuffer();</span>

        // Map&lt;String, Object&gt;content = new HashMap&lt;&gt;();
        try {
            // InputStream d = con.getInputStream();
<span class="nc" id="L228">            BufferedReader in = new BufferedReader(</span>
<span class="nc" id="L229">                    new InputStreamReader(con.getInputStream()));</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            while ((inputLine = in.readLine()) != null) {</span>
<span class="nc" id="L231">                content.append(inputLine);</span>
                // content.put(inputLine, null);
                // System.out.println(&quot;input: &quot;+inputLine);

            }
<span class="nc" id="L236">            in.close();</span>
<span class="nc" id="L237">        } catch (Exception e) {</span>
<span class="nc" id="L238">            System.out.println(e.getMessage());</span>
<span class="nc" id="L239">        }</span>

<span class="nc" id="L241">        return content;</span>
    }

    public HttpURLConnection prepare() {

<span class="nc" id="L246">        this.con.setDoOutput(true);</span>
        try {
<span class="nc" id="L248">            DataOutputStream out = new DataOutputStream(this.con.getOutputStream());</span>
<span class="nc" id="L249">            out.writeBytes(getParamsString(params));</span>
<span class="nc" id="L250">            out.flush();</span>
<span class="nc" id="L251">            out.close();</span>
<span class="nc" id="L252">        } catch (IOException e) {</span>
<span class="nc" id="L253">            System.out.print(e.getMessage());</span>
<span class="nc" id="L254">            System.out.print(e.getStackTrace());</span>
<span class="nc" id="L255">        }</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">        for (Map.Entry&lt;String, String&gt; entry : headers.entrySet()) {</span>
<span class="nc" id="L258">            this.con.setRequestProperty(entry.getKey(), entry.getValue());</span>
<span class="nc" id="L259">        }</span>
<span class="nc" id="L260">        return this.con;</span>

    }

    public static String getParamsString(Map&lt;String, String&gt; params) {
<span class="nc" id="L265">        StringBuilder result = new StringBuilder();</span>
        try {
<span class="nc bnc" id="L267" title="All 2 branches missed.">            for (Map.Entry&lt;String, String&gt; entry : params.entrySet()) {</span>
<span class="nc" id="L268">                result.append(URLEncoder.encode(entry.getKey(), &quot;UTF-8&quot;));</span>
<span class="nc" id="L269">                result.append(&quot;=&quot;);</span>
<span class="nc" id="L270">                result.append(URLEncoder.encode(entry.getValue(), &quot;UTF-8&quot;));</span>
<span class="nc" id="L271">                result.append(&quot;&amp;&quot;);</span>
<span class="nc" id="L272">            }</span>
<span class="nc" id="L273">        } catch (Exception e) {</span>
<span class="nc" id="L274">            System.out.println(e.getMessage());</span>
<span class="nc" id="L275">        }</span>
<span class="nc" id="L276">        String resultString = result.toString();</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">        return resultString.length() &gt; 0</span>
<span class="nc" id="L278">                ? resultString.substring(0, resultString.length() - 1)</span>
<span class="nc" id="L279">                : resultString;</span>
    }

    public String getResponse(HttpURLConnection con) throws IOException {
<span class="nc" id="L283">        Reader streamReader = null;</span>

<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (con.getResponseCode() &gt; 299) {</span>
<span class="nc" id="L286">            streamReader = new InputStreamReader(con.getErrorStream());</span>
        } else {
<span class="nc" id="L288">            streamReader = new InputStreamReader(con.getInputStream());</span>
        }

<span class="nc" id="L291">        BufferedReader in = new BufferedReader(streamReader);</span>
        String inputLine;
<span class="nc" id="L293">        StringBuilder content = new StringBuilder();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        while ((inputLine = in.readLine()) != null) {</span>
<span class="nc" id="L295">            content.append(inputLine);</span>
        }

<span class="nc" id="L298">        in.close();</span>
<span class="nc" id="L299">        return content.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>